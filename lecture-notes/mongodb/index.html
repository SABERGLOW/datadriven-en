


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Dudás Ákos">
      
      <link rel="shortcut icon" href="../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.4.0">
    
    
      
        <title>MongoDB operations and the MongoDB .NET Driver - BMEVIAUAC01 Data-driven systems</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.fe0cca5b.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a46bcfb3.min.css">
      
      
        
        
        <meta name="theme-color" content="#ef5350">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../extra-material-theme.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mongodb-operations-and-the-mongodb-net-driver" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="BMEVIAUAC01 Data-driven systems" class="md-header-nav__button md-logo" aria-label="BMEVIAUAC01 Data-driven systems">
      
  <img src="../../img/logo-bme-aut.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            BMEVIAUAC01 Data-driven systems
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              MongoDB operations and the MongoDB .NET Driver
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/bmeviauac01/datadriven-en/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bmeviauac01/datadriven-en
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Data-driven systems
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../db/" class="md-tabs__link">
          Database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../architecture/" class="md-tabs__link md-tabs__link--active">
          Lecture notes
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../seminar/transactions/" class="md-tabs__link">
          Seminars
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../homework/" class="md-tabs__link">
          Homework
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="BMEVIAUAC01 Data-driven systems" class="md-nav__button md-logo" aria-label="BMEVIAUAC01 Data-driven systems">
      
  <img src="../../img/logo-bme-aut.png" alt="logo">

    </a>
    BMEVIAUAC01 Data-driven systems
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/bmeviauac01/datadriven-en/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bmeviauac01/datadriven-en
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Data-driven systems" class="md-nav__link">
      Data-driven systems
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Database
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Database" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/" title="Sample database scheme" class="md-nav__link">
      Sample database scheme
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/mssql/" title="Using Microsoft SQL Server" class="md-nav__link">
      Using Microsoft SQL Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/mongodb/" title="Using MongoDB" class="md-nav__link">
      Using MongoDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://raw.githubusercontent.com/bmeviauac01/adatvezerelt/master/docs/db/mssql.sql" title="Sample database: mssql.sql" class="md-nav__link">
      Sample database: mssql.sql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://raw.githubusercontent.com/bmeviauac01/adatvezerelt/master/docs/db/mongo.js" title="Sample database: mongo.js" class="md-nav__link">
      Sample database: mongo.js
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Lecture notes
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Lecture notes" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Lecture notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../architecture/" title="Data-driven systems and the thee- or multi-tier architecture" class="md-nav__link">
      Data-driven systems and the thee- or multi-tier architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../transactions/" title="Transactions in databases" class="md-nav__link">
      Transactions in databases
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mssql/sql/" title="SQL language, MSSQL platform-specific SQL" class="md-nav__link">
      SQL language, MSSQL platform-specific SQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mssql/server-side-programming/" title="Microsoft SQL Server programming" class="md-nav__link">
      Microsoft SQL Server programming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linq/" title="LINQ: Language Integrated Query" class="md-nav__link">
      LINQ: Language Integrated Query
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        MongoDB operations and the MongoDB .NET Driver
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="MongoDB operations and the MongoDB .NET Driver" class="md-nav__link md-nav__link--active">
      MongoDB operations and the MongoDB .NET Driver
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#establishing-a-connection" class="md-nav__link">
    Establishing a connection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-collections" class="md-nav__link">
    Managing collections
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mapping-documents-to-c-objects" class="md-nav__link">
    Mapping documents to C# objects
  </a>
  
    <nav class="md-nav" aria-label="Mapping documents to C# objects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-mapping" class="md-nav__link">
    Customizing the mapping
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    Queries
  </a>
  
    <nav class="md-nav" aria-label="Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-query-results" class="md-nav__link">
    Using query results
  </a>
  
    <nav class="md-nav" aria-label="Using query results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listing" class="md-nav__link">
    Listing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-firstsingle-item" class="md-nav__link">
    Get first/single item
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cursor" class="md-nav__link">
    Cursor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operators-for-filtering" class="md-nav__link">
    Operators for filtering
  </a>
  
    <nav class="md-nav" aria-label="Operators for filtering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comparison-operators" class="md-nav__link">
    Comparison operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boolean-operators" class="md-nav__link">
    Boolean operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#value-is-one-of-multiple-alternatives" class="md-nav__link">
    Value is one of multiple alternatives
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#value-exists-not-null" class="md-nav__link">
    Value exists (not null)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtering-fields-of-embedded-document" class="md-nav__link">
    Filtering fields of embedded document
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtering-based-on-an-array-field" class="md-nav__link">
    Filtering based on an array field
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-execution-pipeline" class="md-nav__link">
    Query execution pipeline
  </a>
  
    <nav class="md-nav" aria-label="Query execution pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#paging-sorting" class="md-nav__link">
    Paging, sorting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-documents" class="md-nav__link">
    Number documents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grouping" class="md-nav__link">
    Grouping
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#insert-modify-delete" class="md-nav__link">
    Insert, Modify, Delete
  </a>
  
    <nav class="md-nav" aria-label="Insert, Modify, Delete">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inserting-a-new-document" class="md-nav__link">
    Inserting a new document
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-documents" class="md-nav__link">
    Delete documents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-documents" class="md-nav__link">
    Updating documents
  </a>
  
    <nav class="md-nav" aria-label="Updating documents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-document-replacement" class="md-nav__link">
    Complete document replacement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#document-update-operators" class="md-nav__link">
    Document update operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upsert-replacing-a-non-existent-document" class="md-nav__link">
    Upsert: replacing a non-existent document
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../di/" title="Dependency Injection ASP.NET Core environment" class="md-nav__link">
      Dependency Injection ASP.NET Core environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/bmeviauac01/rest-webapi-sample" title="REST and WebAPI sample app (GitHub)" class="md-nav__link">
      REST and WebAPI sample app (GitHub)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/bmeviauac01/todoapi-di-sample" title="ASP.NET Core DI sample app (GitHub)" class="md-nav__link">
      ASP.NET Core DI sample app (GitHub)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/bmeviauac01/threelayered-aspnetcore-sample" title="Sample three-tier webapp (GitHub)" class="md-nav__link">
      Sample three-tier webapp (GitHub)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Seminars
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Seminars" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Seminars
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../seminar/transactions/" title="Transactions" class="md-nav__link">
      Transactions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../seminar/mssql/" title="Microsoft SQL Server programming" class="md-nav__link">
      Microsoft SQL Server programming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../seminar/ef/" title="Entity Framework" class="md-nav__link">
      Entity Framework
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../seminar/mongodb/" title="MongoDB" class="md-nav__link">
      MongoDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../seminar/jpa/" title="JPA & Spring Data" class="md-nav__link">
      JPA & Spring Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../seminar/rest/" title="REST API & ASP.NET Web API" class="md-nav__link">
      REST API & ASP.NET Web API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Homework
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Homework" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Homework
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/" title="Optional homework" class="md-nav__link">
      Optional homework
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/mssql/" title="Exercise: MSSQL server-side programming" class="md-nav__link">
      Exercise: MSSQL server-side programming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/adonet/" title="Exercise: ADO.NET data access" class="md-nav__link">
      Exercise: ADO.NET data access
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/ef/" title="Exercise: Entity Framework" class="md-nav__link">
      Exercise: Entity Framework
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/mongodb/" title="Exercise: MongoDB" class="md-nav__link">
      Exercise: MongoDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/rest/" title="Exercise: REST API and Web API" class="md-nav__link">
      Exercise: REST API and Web API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/GitHub/" title="Submitting your work (GitHub)" class="md-nav__link">
      Submitting your work (GitHub)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/GitHub-Actions/" title="Using GitHub Actions" class="md-nav__link">
      Using GitHub Actions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../homework/VisualStudio/" title="Install Visual Studio" class="md-nav__link">
      Install Visual Studio
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#establishing-a-connection" class="md-nav__link">
    Establishing a connection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-collections" class="md-nav__link">
    Managing collections
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mapping-documents-to-c-objects" class="md-nav__link">
    Mapping documents to C# objects
  </a>
  
    <nav class="md-nav" aria-label="Mapping documents to C# objects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-mapping" class="md-nav__link">
    Customizing the mapping
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    Queries
  </a>
  
    <nav class="md-nav" aria-label="Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-query-results" class="md-nav__link">
    Using query results
  </a>
  
    <nav class="md-nav" aria-label="Using query results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listing" class="md-nav__link">
    Listing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-firstsingle-item" class="md-nav__link">
    Get first/single item
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cursor" class="md-nav__link">
    Cursor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operators-for-filtering" class="md-nav__link">
    Operators for filtering
  </a>
  
    <nav class="md-nav" aria-label="Operators for filtering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comparison-operators" class="md-nav__link">
    Comparison operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boolean-operators" class="md-nav__link">
    Boolean operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#value-is-one-of-multiple-alternatives" class="md-nav__link">
    Value is one of multiple alternatives
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#value-exists-not-null" class="md-nav__link">
    Value exists (not null)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtering-fields-of-embedded-document" class="md-nav__link">
    Filtering fields of embedded document
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtering-based-on-an-array-field" class="md-nav__link">
    Filtering based on an array field
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-execution-pipeline" class="md-nav__link">
    Query execution pipeline
  </a>
  
    <nav class="md-nav" aria-label="Query execution pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#paging-sorting" class="md-nav__link">
    Paging, sorting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#number-documents" class="md-nav__link">
    Number documents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grouping" class="md-nav__link">
    Grouping
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#insert-modify-delete" class="md-nav__link">
    Insert, Modify, Delete
  </a>
  
    <nav class="md-nav" aria-label="Insert, Modify, Delete">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inserting-a-new-document" class="md-nav__link">
    Inserting a new document
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-documents" class="md-nav__link">
    Delete documents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-documents" class="md-nav__link">
    Updating documents
  </a>
  
    <nav class="md-nav" aria-label="Updating documents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-document-replacement" class="md-nav__link">
    Complete document replacement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#document-update-operators" class="md-nav__link">
    Document update operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upsert-replacing-a-non-existent-document" class="md-nav__link">
    Upsert: replacing a non-existent document
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/bmeviauac01/datadriven-en/edit/master/docs/lecture-notes/mongodb/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="mongodb-operations-and-the-mongodb-net-driver">MongoDB operations and the MongoDB .NET Driver<a class="headerlink" href="#mongodb-operations-and-the-mongodb-net-driver" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p>The following code snippets use the official Nuget package <a href="https://www.nuget.org/packages/mongodb.driver">MongoDB.Driver</a>.</p>
</div>
<h2 id="establishing-a-connection">Establishing a connection<a class="headerlink" href="#establishing-a-connection" title="Permanent link">&para;</a></h2>
<p>To access the MongoDB database, you first need a connection. A <code>MongoClient</code> class represents the connection. We need the server address to establish a connection (see <a href="https://docs.mongodb.com/manual/reference/connection-string/">https://docs.mongodb.com/manual/reference/connection-string/</a> for details on the connection string).</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s">&quot;mongodb://localhost:27017&quot;</span><span class="p">);</span>
</code></pre></div>

<p>The connection should be treated as a singleton and not disposed of.</p>
<div class="admonition info">
<p class="admonition-title">Connection lifetime</p>
<p>The connection is typically stored in a global static variable, or an IoC (Inversion of Control) / DI (Dependency Injection) store.</p>
</div>
<p>Although the database name may be in the connection string (e.g. <code>mongodb://localhost:27017/datadriven</code>), it is used only for authentication. Thus, after establishing the connection, we need to specify what database we will use.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">GetDatabase</span><span class="p">(</span><span class="s">&quot;datadriven&quot;</span><span class="p">);</span>
</code></pre></div>

<p>The database does not need to exist in advance. The above call will automatically create if the database does not already exist.</p>
<h2 id="managing-collections">Managing collections<a class="headerlink" href="#managing-collections" title="Permanent link">&para;</a></h2>
<p>Unlike a relational database, <strong>in MongoDB, our operations are always performed on a single collection</strong>, so the selection of a collection is not part of the issued command (like <code>where</code> in SQL), but a prerequisite for the operation. You can get a specific collection by calling <code>GetCollection</code>; its generic parameter is the C# class implementing the document type.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">collection</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">GetCollection</span><span class="p">&lt;</span><span class="n">BsonDocument</span><span class="p">&gt;(</span><span class="s">&quot;products&quot;</span><span class="p">);</span>
</code></pre></div>

<p>The basic concept of the .NET MongoDB driver is to map every document to a .NET object. This is also called <em>ODM (Object Document Mapping)</em>. ODM is the equivalent of ORM in the NoSQL database world.</p>
<div class="admonition warning">
<p class="admonition-title">"Raw" json</p>
<p>In other languages and platforms, MongoDB drivers do not always map to objects. Sample codes found on the Internet often show communication via "raw" JSON documents. Let's try to avoid this, as we learned in ORM, that object-oriented mapping is more convenient and secure.</p>
</div>
<p>In the previous example, a document of the type "BsonDocument" is used. <code>BsonDocument</code> is a generic document representation in which we can store key-value pairs. It is uncomfortable and unsafe to use; thus we usually do try to avoid it. See the suggested solution soon.</p>
<p>You can run queries on the variable representing the collection, such as inserting a document and then listing the contents of the collection. The collection will be created automatically the first time you use it, so you don't have to define it.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">InsertOne</span><span class="p">(</span><span class="k">new</span> <span class="n">BsonDocument</span><span class="p">()</span>
<span class="p">{</span>
    <span class="p">{</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;categoryName&quot;</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;price&quot;</span><span class="p">,</span> <span class="m">123</span> <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// listing all documents: a search criteria is needed</span>
<span class="c1">// this is an empty criteria matching all documents</span>
<span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">new</span> <span class="n">BsonDocument</span><span class="p">()).</span><span class="n">ToList</span><span class="p">();</span>
<span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">l</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
</code></pre></div>

<div class="admonition important">
<p class="admonition-title">Naming convention</p>
<p>Field names in the document start with lowercase letters like <code>price</code> or <code>categoryName</code> (this is the so-called <em>camel case</em> spelling). This is a <strong>convention</strong> of the MongoDB world for historical reasons. Unless there is a good reason, do not deviate from it.</p>
</div>
<h2 id="mapping-documents-to-c-objects">Mapping documents to C# objects<a class="headerlink" href="#mapping-documents-to-c-objects" title="Permanent link">&para;</a></h2>
<p>As with relational databases, we can work with objects and classes in MongoDB. The .NET driver for MongoDB offers this conveniently.</p>
<p>The first step is to define the C# class(es) to map the contents of the database. Since there is no schema for the database and table, we cannot generate C# code based on the schema (as we did with the Entity Framework). So in this world, we tend to follow the <em>Code First</em> approach, which is to write C# code and have the system translate it to database collections.</p>
<p>Let us define the following classes to represent <em>Products</em>.</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ObjectId</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// this will be the identifier with name _id</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Stock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">Categories</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// array field</span>
    <span class="k">public</span> <span class="n">VAT</span> <span class="n">VAT</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// embedded document</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">VAT</span> <span class="c1">// this class is only ever embedded, hence needs to id</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">VATCategoryName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">Percentage</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Note that the name of the field was <code>price</code> before, but in C# it starts with a capital letter, according to <em>Pascal Case</em>: <code>Price</code>. The MongoDB .NET driver integrates with the C# language and the .NET environment and respects its conventions so that the names in the class definition and the field names in the MongoDB documents will be mapped automatically: the <code>Price</code> class property will be <code>price</code> in the document.</p>
<h3 id="customizing-the-mapping">Customizing the mapping<a class="headerlink" href="#customizing-the-mapping" title="Permanent link">&para;</a></h3>
<p>The C# class - MongoDB document mapping is automatic, but it can also be customized. There are several ways to deviate from the conventions.</p>
<p>The easiest way is to use custom attributes in the class definition:</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="c1">// maps to field _id</span>
<span class="na">    [BsonId]</span>
    <span class="k">public</span> <span class="n">ObjectId</span> <span class="n">Identifier</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">// can specify the name explicitly</span>
<span class="na">    [BsonElement(&quot;price&quot;)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">TotalPrice</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">// properties can be ignores</span>
<span class="na">    [BsonIgnore]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">DoNotSace</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Our other option is to register so-called <em>convention packs</em> at a higher level. The convention pack describes the rules of mapping. (A set of conventions also defines the default behavior.)</p>
<p>For example, you can specify the following to map the field names to camel case and exclude data members with a default value (defined in the C# language) from the document.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// defince convention pack</span>
<span class="kt">var</span> <span class="n">pack</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ConventionPack</span><span class="p">();</span>
<span class="n">pack</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">CamelCaseElementNameConvention</span><span class="p">());</span>
<span class="n">pack</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">IgnoreIfDefaultConvention</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>

<span class="c1">// register the convention pack</span>
<span class="c1">// the first parameter is a name to reference this pack</span>
<span class="c1">// the last argument is a fitlering criteria when to use this convention</span>
<span class="n">ConventionRegistry</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;datadriven&quot;</span><span class="p">,</span> <span class="n">pack</span><span class="p">,</span> <span class="n">t</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">);</span>
</code></pre></div>

<p>We also have more sophisticated customizations, such as defining conversion logic for translation between a C# representation and a MongoDB representation, and specifying how to save inheritance hierarchies. For more details, see the official documentation: <a href="https://mongodb.github.io/mongo-csharp-driver/2.8/reference/bson/serialization/">https://mongodb.github.io/mongo-csharp-driver/2.8/reference/bson/serialization/</a>.</p>
<h2 id="queries">Queries<a class="headerlink" href="#queries" title="Permanent link">&para;</a></h2>
<p>We will use the collection from now on by mapping it to the <code>Product</code> class. This is the recommended solution; the <code>BsonDocument</code> based solution is used only when necessary.</p>
<p>The simplest query we have already seen is to list all the documents:</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">collection</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">GetCollection</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">&quot;products&quot;</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">new</span> <span class="n">BsonDocument</span><span class="p">()).</span><span class="n">ToList</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;Id: {p.Id}, Name: {p.Name}&quot;</span><span class="p">);</span>
</code></pre></div>

<p>Listing is done using the <code>Find</code> method. The name illustrates MongoDB's philosophy: listing an entire collection is not practical, so there is no simple syntax for it. <code>Find</code> requires a search criteria, which is an empty condition here to matches everything.</p>
<p>There are several ways to describe search criteria.</p>
<p>With <strong><code>BsonDocument</code></strong> based filtering, the filtering condition must be written according to the MongoDB syntax. We generally will avoid this because the MongoDB .NET driver provides a more convenient solution for us.</p>
<p>In most cases, we can use <strong>Lambda expressions</strong> to describe the filtering.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">123</span><span class="p">);</span>
</code></pre></div>

<p>In this case, the Lambda expression is a delegate of type <code>Predicate &lt;T&gt;</code>, that is, expects a <code>Product</code> and returns <code>bool</code>. Thus in the example above, the <code>x</code> variable represents a <code>Products</code> instance. Of course, this search also works for more complex cases.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">123</span> <span class="p">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">));</span>
</code></pre></div>

<p>The filtering described by the Lambda expressions hides what search syntax we actually have in MongoDB. For example, the above <code>Contains</code> search condition will actually mean a search with a regular expression.</p>
<p>In MongoDB's own language, the previous filter looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;price&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;$lt&quot;</span><span class="p">:</span> <span class="mf">123.0</span>
  <span class="p">},</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;/red/s&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p>Note that this description is itself a document. If we wanted to write the filter condition ourselves, we would have to create this descriptor in a <code>BsonDocument</code>. The document keys describe the fields used for filtering, and the values are the filter criteria. In some cases, the condition is a scalar value such as a regular expression (or if we filter for equality); in other cases, the condition is an embedded document, as with the <code>&lt;</code> condition. Here, the <code>$lt</code> key is a special key that denotes the <em>less than</em> operator and the value to the right of the operator is 123.0. The regular expression should be specified according to <a href="https://www.w3schools.com/jsref/jsref_obj_regexp.asp">JavaScript RegExp Syntax</a>. The conditions listed in this way are automatically evaluated in and <code>and</code> fashion.</p>
<p>Instead of the Lambda expression, we can create a similar description without having to compile a filter condition in "text" form. The .NET driver for MongoDB gives us the ability to use a so-called <strong><em>builders</em></strong>.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span>
    <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">And</span><span class="p">(</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">),</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Regex</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">&quot;/red/s&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<p>The above syntax is a bit more eloquent than the Lambda expression, but it is closer to the MongoDB philosophy, and better describes what we want. We can view this syntax as SQL, a declarative, goal-oriented, but platform-specific description. However, it is also type-safe.</p>
<p>The <code>Builders&lt;T&gt;</code> generic class is an auxiliary class that we can use to build filtering and other MongoDB specific definitions. <code>Builders&lt;Product&gt;.Filter</code> can be used to define filtering conditions that match the <em>Product</em> C# class. First, we create an <em>and</em> connection, within which we have two filtering conditions. The operators are the <em>less than</em> and regular expressions seen before. We pass two parameters to these functions: the field to be filtered and the operand.</p>
<p>Note that no string-based field names were used here or in the Lambda expressions. We can refer to the class fields with the <em>C# Expression</em> syntax. This is practical because we avoid typing field names.</p>
<p>Note that all ways of describing the search criteria are identical. The MongoDB driver maps each syntax to its internal representation. Lambda expression-based requires fewer characters and fits better into C#, while the builder approach is used to express MongoDB features better. You can use either one.</p>
<h3 id="using-query-results">Using query results<a class="headerlink" href="#using-query-results" title="Permanent link">&para;</a></h3>
<p>The result of the <code>collection.Find(...)</code> function is not yet the result set, but only a descriptor to execute the query. There are generally three ways to retrieve and process the result.</p>
<h4 id="listing">Listing<a class="headerlink" href="#listing" title="Permanent link">&para;</a></h4>
<p>Get the complete result set as a list: <code>collection.Find(...).ToList()</code>.</p>
<h4 id="get-firstsingle-item">Get first/single item<a class="headerlink" href="#get-firstsingle-item" title="Permanent link">&para;</a></h4>
<p>If you only need the first item, or know that there will be only one item, you can use <code>collection.Find(...).First()</code>, <code>.FirstOrDefault()</code>, or <code>.Single()</code>, <code>.SingleOrDefault()</code> functions.</p>
<h4 id="cursor">Cursor<a class="headerlink" href="#cursor" title="Permanent link">&para;</a></h4>
<p>If the result set contains multiple documents, it is advisable to iterate it using a cursor. MongoDB limits the size of the response to a query, so if we query too many records, we may get an error instead of a result. To overcome this, we use the cursors where we always get only a subset of the documents.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">cur</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(...).</span><span class="n">ToCursor</span><span class="p">();</span>
<span class="k">while</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span> <span class="c1">// cursor stepping</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">t</span> <span class="k">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">Current</span><span class="p">)</span> <span class="c1">// the value of the cursor is not a single document, but a list in itself</span>
    <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="operators-for-filtering">Operators for filtering<a class="headerlink" href="#operators-for-filtering" title="Permanent link">&para;</a></h3>
<p>The filter criteria apply to the fields in the document, and the filter criteria are always constant. Thus <strong>it is not possible, for example, to compare two fields</strong>, and we cannot refer to other collections. There is a so-called MongoDB aggregation pipeline, which allows you to formulate more complex queries, but for now, let us focus on simple queries.</p>
<p>The filter condition compares a field in the document to a constant we specify. The following options are most commonly used.</p>
<h4 id="comparison-operators">Comparison operators<a class="headerlink" href="#comparison-operators" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">==</span> <span class="m">123</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">));</span> <span class="c1">//Eq, as in equals</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">!=</span> <span class="m">123</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Ne</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">));</span> <span class="c1">// Ne, as in not equals</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&gt;=</span> <span class="m">123</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Gte</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">));</span> <span class="c1">// Gte, as in greater than or equal to</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">123</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">));</span> <span class="c1">// Lt, as in less than</span>
</code></pre></div>

<h4 id="boolean-operators">Boolean operators<a class="headerlink" href="#boolean-operators" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&gt;</span> <span class="m">500</span> <span class="p">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">1000</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span>
    <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">And</span><span class="p">(</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Gt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">500</span><span class="p">),</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">1000</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">500</span> <span class="p">||</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span>
    <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Or</span><span class="p">(</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">500</span><span class="p">),</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">!(</span><span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">500</span> <span class="p">||</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">));</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span>
    <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Not</span><span class="p">(</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Or</span><span class="p">(</span>
            <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">500</span><span class="p">),</span>
            <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<h4 id="value-is-one-of-multiple-alternatives">Value is one of multiple alternatives<a class="headerlink" href="#value-is-one-of-multiple-alternatives" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="p">...</span> <span class="p">||</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="p">...);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">In</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}));</span>
<span class="c1">// similarly Nin, as in not in operátor</span>
</code></pre></div>

<h4 id="value-exists-not-null">Value exists (not null)<a class="headerlink" href="#value-exists-not-null" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">));</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Exists filtering</p>
<p>Does exist, that is, non-null filtering is special because there are two ways to have a null value in MongoDB: if the key exists in the document and it has a value of null; or if the key does not exist at all.</p>
</div>
<h3 id="filtering-fields-of-embedded-document">Filtering fields of embedded document<a class="headerlink" href="#filtering-fields-of-embedded-document" title="Permanent link">&para;</a></h3>
<p>Embedded documents can be used for filtering in the same way. The following are all valid, and it does not matter if the embedded document (<em>VAT</em>) does not exist:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span> <span class="p">&lt;</span> <span class="m">27</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span><span class="p">,</span> <span class="m">27</span><span class="p">));</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span><span class="p">,</span> <span class="n">exists</span><span class="p">:</span> <span class="k">false</span><span class="p">));</span>
<span class="c1">// does not exists, that is, in C#, equals null</span>
</code></pre></div>

<h3 id="filtering-based-on-an-array-field">Filtering based on an array field<a class="headerlink" href="#filtering-based-on-an-array-field" title="Permanent link">&para;</a></h3>
<p>Any field in the document can be an array value, as in the example <code>string [] Categories</code>. In MongoDB, we can define filtering based on an array field using the <code>Any*</code> criterion.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// products of this category</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Balls&quot;</span><span class="p">));</span>

<span class="c1">// products that are assigned to at least one category not listed by name</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyNin</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;Balls&quot;</span><span class="p">,</span> <span class="s">&quot;Rackets&quot;</span> <span class="p">}));</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Any...</p>
<p>The <code>Any*</code> conditions look at every element of an array but match only once with respect to the document. So, if multiple elements of an array match a condition, we only get the document once in the result set.</p>
</div>
<h2 id="query-execution-pipeline">Query execution pipeline<a class="headerlink" href="#query-execution-pipeline" title="Permanent link">&para;</a></h2>
<p>MongoDB queries executed through a pipeline. We won't go into details about this, but in addition to simple filtering, we'll see a few examples frequently used in queries.</p>
<h4 id="paging-sorting">Paging, sorting<a class="headerlink" href="#paging-sorting" title="Permanent link">&para;</a></h4>
<p>For paging, we specify the maximum number of matching documents we request:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(...).</span><span class="n">Limit</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</code></pre></div>

<p>And for the items on the following page, we skip the items already seen on the first page:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(...).</span><span class="n">Skip</span><span class="p">(</span><span class="m">100</span><span class="p">).</span><span class="n">Limit</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</code></pre></div>

<p><code>Skip</code> and <code>Limit</code> are meaningless in this form because without sorting, the "first 100 elements" query is not deterministic. So for these types of queries, it is necessary to provide an appropriate sorting requirement. Sorting is defined using <code>Builders&lt;T&gt;</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(...)</span>
    <span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Sort</span><span class="p">.</span><span class="n">Ascending</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">100</span><span class="p">).</span><span class="n">Limit</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</code></pre></div>

<div class="admonition question">
<p class="admonition-title">Paging issue</p>
<p>The above paging mechanism is still not entirely correct. For example, if a product is deleted in between the query of the first and second pages, the products will shift by one, and there may be a product that will be skipped. This is, in fact, not a problem just with MongoDB. Consider how you would solve this problem.</p>
</div>
<h4 id="number-documents">Number documents<a class="headerlink" href="#number-documents" title="Permanent link">&para;</a></h4>
<p>There are two ways to query the number of documents that match a query:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">CountDocuments</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Balls&quot;</span><span class="p">));</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Balls&quot;</span><span class="p">)).</span><span class="n">CountDocuments</span><span class="p">();</span>
</code></pre></div>

<h4 id="grouping">Grouping<a class="headerlink" href="#grouping" title="Permanent link">&para;</a></h4>
<p>Grouping is a syntactically complex operation. For grouping, we need to define an aggregation pipeline. We will not discuss this in more detail, but the following example shows its use.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// products in the &quot;Balls&quot; category grouped by VAT percentage</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">g</span> <span class="k">in</span> <span class="n">collection</span><span class="p">.</span><span class="n">Aggregate</span><span class="p">()</span>
                            <span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Balls&quot;</span><span class="p">))</span> <span class="c1">// filtering</span>
                            <span class="p">.</span><span class="n">Group</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="c1">// grouping</span>
                            <span class="p">.</span><span class="n">ToList</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;VAT percentage: {g.Key}&quot;</span><span class="p">);</span>
    <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">g</span><span class="p">)</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;\tProduct: {p.Name}&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="insert-modify-delete">Insert, Modify, Delete<a class="headerlink" href="#insert-modify-delete" title="Permanent link">&para;</a></h2>
<p>After queries, let's get to know data modification constructs.</p>
<h3 id="inserting-a-new-document">Inserting a new document<a class="headerlink" href="#inserting-a-new-document" title="Permanent link">&para;</a></h3>
<p>To insert a new document, you need the object representing the new document. We can add this to the collection.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">newProduct</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Product</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Apple&quot;</span><span class="p">,</span>
    <span class="n">Price</span> <span class="p">=</span> <span class="m">890</span><span class="p">,</span>
    <span class="n">Categories</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;Fruits&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">collection</span><span class="p">.</span><span class="n">InsertOne</span><span class="p">(</span><span class="n">newProduct</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;Inserted record id id: {newProduct.Id}&quot;</span><span class="p">);</span> <span class="c1">// after insert the ID of the document will be available in the C# instance</span>
</code></pre></div>

<p>Note that the <code>Id</code> field is not assigned. This will be set by the client driver. If we want, we can give it a value, but it is not customary.</p>
<p>Remember, there is no schema in MongoDB, so the inserted document may be completely different from the rest of the items in the collection. Note that not all fields are assigned values. Because there are no integrity criteria, any insertion will be successful, but there may be problems with queries (for example, assuming that the <code>Stock</code> field is always set).</p>
<p>You can use the <code>InsertMany</code> function to insert multiple documents, but remember that there are no transactions, so adding multiple documents is an independent operation. If, for any reason, an error occurs during the insertion, the successfully inserted documents will remain in the database. However, each document is saved atomically, so no "half" document can be added to the database in the event of an error.</p>
<h3 id="delete-documents">Delete documents<a class="headerlink" href="#delete-documents" title="Permanent link">&para;</a></h3>
<p>To delete, you need to define a filter condition and execute it with the <code>DeleteOne</code> or <code>DeleteMany</code> functions. The difference is that <code>DeleteOne</code> only deletes the <em>first</em> matching document, while <code>DeleteMany</code> deletes all. If you know that only one document can match this condition (for example, deleting it by ID), you should use <code>DeleteOne</code> as the database does not have to perform an exhaustive search.</p>
<p>The deletion condition can be described by the syntax familiar to the search.</p>
<div class="admonition note">
<p>Deletion is different from Entity Framework. Here, the entity does not have to be loaded; instead, we specify a filtering condition.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">deleteResult</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">DeleteOne</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">));</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;Deleted: {deleteResult.DeletedCount} records&quot;</span><span class="p">);</span>
</code></pre></div>

<p>If you want to retrieve the deleted element, you can use <code>FindOneAndDelete</code>, which returns the deleted entity.</p>
<h3 id="updating-documents">Updating documents<a class="headerlink" href="#updating-documents" title="Permanent link">&para;</a></h3>
<p>Perhaps the most interesting feature of MongoDB is the update of documents. While the functionalities showed before (queries, inserts, deletions) are similar to most databases (either relational or NoSQL), MongoDB supports a much broader range of modification operations.</p>
<p>There are two ways to change a document: replace the entire document with a new one or update its parts.</p>
<h4 id="complete-document-replacement">Complete document replacement<a class="headerlink" href="#complete-document-replacement" title="Permanent link">&para;</a></h4>
<p>To replace a document completely, we need a filtering condition to specify which document we want to replace; and we need a new document.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">replacementProduct</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Product</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Apple&quot;</span><span class="p">,</span>
    <span class="n">Price</span> <span class="p">=</span> <span class="m">890</span><span class="p">,</span>
    <span class="n">Categories</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;Fruit&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="kt">var</span> <span class="n">replaceResult</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">ReplaceOne</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">),</span> <span class="n">replacementProduct</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;Updated: {replaceResult.ModifiedCount}&quot;</span><span class="p">);</span>
</code></pre></div>

<p>A single document is matched and replaces it with another document. The operation itself is atomic, that is, if it is interrupted, no half document is saved. You can use the <code>FindOneAndReplace</code> method to get the pre-swap document.</p>
<div class="admonition note">
<p class="admonition-title">Interesting</p>
<p>It is also possible to change the document ID during update (the replacement document can have a different ID).</p>
</div>
<h4 id="document-update-operators">Document update operators<a class="headerlink" href="#document-update-operators" title="Permanent link">&para;</a></h4>
<p>Document update operators can change the value of a document's fields atomically without replacing the entire document. We use the help of the <code>Builder&lt;T&gt;</code> to describe the modifying operations.</p>
<p>Set your stock to a constant value:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">UpdateOne</span><span class="p">(</span>
    <span class="n">filter</span><span class="p">:</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">),</span>
    <span class="n">update</span><span class="p">:</span> <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Update</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="m">5</span><span class="p">));</span>
</code></pre></div>

<p>The first parameter of the <code>UpdateOne</code> function is the filter condition. You can use any of the syntax described before. The second parameter is the descriptor of the update operation, which you can build with <code>Builders&lt;T&gt;</code>.</p>
<p>In the example code above, the argument names are specified (<code>filter:</code> and <code>update:</code>) to make it clear what the parameter represents. This is optional, but it increases readability (at the expense of code length).</p>
<p>The operation can update multiple fields at the same time.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">UpdateOne</span><span class="p">(</span>
    <span class="n">filter</span><span class="p">:</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">),</span>
    <span class="n">update</span><span class="p">:</span> <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Update</span>
                <span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
                <span class="p">.</span><span class="n">CurrentDate</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">StockUpdated</span><span class="p">)</span>
                <span class="p">.</span><span class="n">Unset</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">NeedsUpdate</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<p>Typical modifier operators are:</p>
<ul>
<li><code>Set</code>: Set the value of the field;</li>
<li><code>SetOnInsert</code>: like <code>Set</code> but executed only when a new document is inserted (see <em>upsert</em> below);</li>
<li><code>Unset</code>: delete field (remove key and value from document);</li>
<li><code>CurrentDate</code>: set the current date;</li>
<li><code>Inc</code>: increment value;</li>
<li><code>Min</code>,<code>Max</code>: change the value of a field if the value entered is smaller / larger than the current value of the field;</li>
<li><code>Mul</code>: value multiplication;</li>
<li><code>PopFirst</code>,<code>PopLast</code>: remove first / last element from an array;</li>
<li><code>Pull</code>: remove value from an array;</li>
<li><code>Push</code>: add value to an array at the end (further options in the same operator: array sorting, keeping the first <em>n</em> element of an array);</li>
<li><code>AddToSet</code>: add a value to an array if it does not already exist.</li>
</ul>
<p>The above operations are meaningful even if the specified field does not exist. Depending on the type of operator, the database will make changes to a default value. For example, for <code>Inc</code> and <code>Mul</code>, the field will be set to 0 and then modified. For array operations, an empty array is modified. For other operations, you can look up the behavior in the <a href="https://docs.mongodb.com/manual/reference/operator/update/">documentation</a>.</p>
<p>Multiple documents can be modified at the same time using this method. The requested update operations are performed on all documents that match the filter criteria.</p>
<p>For example: in view of the summer season, put <em>all</em> balls on sale with a 25% discount.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">UpdateMany</span><span class="p">(</span>
    <span class="n">filter</span><span class="p">:</span> <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Balls&quot;</span><span class="p">),</span>
    <span class="n">update</span><span class="p">:</span> <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Update</span><span class="p">.</span><span class="n">Mul</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">0.75</span><span class="p">)</span>
                                   <span class="p">.</span><span class="n">AddToSet</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;On sale&quot;</span><span class="p">));</span>
</code></pre></div>

<p>Update operators change the documents atomically. Using them can eliminate some of the problems caused by concurrent data access.</p>
<h4 id="upsert-replacing-a-non-existent-document"><em>Upsert</em>: replacing a non-existent document<a class="headerlink" href="#upsert-replacing-a-non-existent-document" title="Permanent link">&para;</a></h4>
<p>During update operations, we have the option <em>upsert (update/insert)</em>. This means that either an insertion or an update is made, depending on whether the item was in the database. The default behavior is <em>not</em> to upsert, we must request it explicitly.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">ReplaceOne</span><span class="p">(</span>
    <span class="n">filter</span><span class="p">:</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">),</span>
    <span class="n">replacement</span><span class="p">:</span> <span class="n">replacementObject</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="k">new</span> <span class="n">UpdateOptions</span><span class="p">()</span> <span class="p">{</span> <span class="n">IsUpsert</span> <span class="p">=</span> <span class="k">true</span> <span class="p">});</span>
</code></pre></div>

<p>We can also do upsert with update operators. As we have seen, modifier operators are not concerned about missing fields. Likewise, it does not matter if the document does not exist; this is equivalent to performing a modifying operation on a completely blank document.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">UpdateOne</span><span class="p">(</span><span class="n">filter</span><span class="p">:</span> <span class="p">...,</span> <span class="n">update</span><span class="p">:</span> <span class="p">...,</span> <span class="n">options</span><span class="p">:</span> <span class="k">new</span> <span class="n">UpdateOptions</span><span class="p">()</span> <span class="p">{</span> <span class="n">IsUpsert</span> <span class="p">=</span> <span class="k">true</span> <span class="p">});</span>
</code></pre></div>

<p>The upsert operation can be a workaround for managing concurrency in the absence of a transaction. Because we do not have a transaction, we cannot verify before insertion that a particular record does not yet exist. Instead, we can use the upsert method, which allows atomic querying and insertion/modification.</p>
<div class="admonition note">
<p class="admonition-title"><code>merge</code></p>
<p>Note: In SQL, the <code>merge</code> command provides a similar solution.</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        

<!-- Application footer -->
<footer class="md-footer">

  <!-- Link to previous and/or next page -->
  
  <div class="md-footer-nav">
    <nav class="md-footer-nav__inner md-grid" aria-label="Footer">

      <!-- Link to previous page -->
      
      <a href="../linq/" title="LINQ: Language Integrated Query"
        class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
        <div class="md-footer-nav__button md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </div>
        <div class="md-footer-nav__title">
          <div class="md-ellipsis">
            <span class="md-footer-nav__direction">
              Previous
            </span>
            LINQ: Language Integrated Query
          </div>
        </div>
      </a>
      

      <!-- Link to next page -->
      
      <a href="../di/" title="Dependency Injection ASP.NET Core environment"
        class="md-footer-nav__link md-footer-nav__link--next" rel="next">
        <div class="md-footer-nav__title">
          <div class="md-ellipsis">
            <span class="md-footer-nav__direction">
              Next
            </span>
            Dependency Injection ASP.NET Core environment
          </div>
        </div>
        <div class="md-footer-nav__button md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
        </div>
      </a>
      
    </nav>
  </div>
  

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">

      <!-- Copyright and theme information -->
      <div class="md-footer-copyright">
        
        <div class="md-footer-copyright__highlight">
          Copyright &copy; BME AUT
        </div>
        
      </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../../assets/javascripts/bundle.b39636ac.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>